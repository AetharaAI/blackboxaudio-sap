x-common-env: &common-env
  POSTGRES_DSN: postgresql+asyncpg://sap:sap@postgres:5432/sap
  VALKEY_URL: valkey://valkey:6379/0
  MINIO_ENDPOINT: minio:9000
  MINIO_ACCESS_KEY: minioadmin
  MINIO_SECRET_KEY: minioadmin
  MINIO_BUCKET: sap-audio
  MINIO_SECURE: "false"
  LOG_LEVEL: INFO
  SAMPLE_RATE: "44100"

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: sap
      POSTGRES_PASSWORD: sap
      POSTGRES_DB: sap
    ports: ["5433:5432"]
    volumes: [pgdata:/var/lib/postgresql/data]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sap"]
      interval: 5s
      retries: 5

  valkey:
    image: valkey/valkey:8-alpine
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports: ["9000:9000", "9001:9001"]
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes: [miniodata:/data]
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  audio-gateway:
    build:
      context: .
      dockerfile: services/audio_gateway/Dockerfile
    ports: ["8000:8000"]
    environment:
      <<: *common-env
    depends_on:
      postgres: { condition: service_healthy }
      valkey: { condition: service_healthy }
      minio: { condition: service_healthy }

  audio-preprocess:
    build:
      context: .
      dockerfile: services/audio_preprocess/Dockerfile
    environment:
      <<: *common-env
    depends_on:
      valkey: { condition: service_healthy }
      minio: { condition: service_healthy }

  asr-worker:
    build:
      context: .
      dockerfile: services/asr_worker/Dockerfile
    environment:
      <<: *common-env
      WHISPER_STREAMING_MODEL: distil-large-v3
      WHISPER_FINAL_MODEL: large-v3
      DEVICE: cuda
      COMPUTE_TYPE: float16
      HF_TOKEN: ${HF_TOKEN:-}
      NVIDIA_VISIBLE_DEVICES: "0"
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["0"]
              capabilities: [gpu]
    depends_on:
      valkey: { condition: service_healthy }
      minio: { condition: service_healthy }
    restart: unless-stopped

  music-worker:
    build:
      context: .
      dockerfile: services/music_worker/Dockerfile
    environment:
      <<: *common-env
    depends_on:
      valkey: { condition: service_healthy }
      minio: { condition: service_healthy }

  aligner:
    build:
      context: .
      dockerfile: services/aligner/Dockerfile
    environment:
      <<: *common-env
    depends_on:
      postgres: { condition: service_healthy }
      valkey: { condition: service_healthy }

  tts-worker:
    build:
      context: .
      dockerfile: services/tts_worker/Dockerfile
    environment:
      <<: *common-env
      CHATTERBOX_URL: https://tts.aetherpro.us
    depends_on:
      valkey: { condition: service_healthy }
      minio: { condition: service_healthy }

  # ─── Voxstral ASR (Primary) ──────────────────────────────────────────────────

  voxstral-vllm:
    image: vllm/vllm-openai:nightly
    command:
      - /models/mistralai/Voxtral-Mini-4B-Realtime-2602
      - --gpu-memory-utilization
      - "0.70"
      - --max-model-len
      - "8192"
      - --compilation_config
      - '{"cudagraph_mode":"PIECEWISE"}'
    ports: ["8001:8000"]
    volumes:
      - /mnt/aetherpro/models/audio:/models:ro
    environment:
      - HF_TOKEN=${HF_TOKEN:-}
      - HF_HOME=/models
      - NVIDIA_VISIBLE_DEVICES=0
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["0"]
              capabilities: [gpu]
    restart: unless-stopped

  voxstral-worker:
    build:
      context: .
      dockerfile: services/voxstral_worker/Dockerfile
    environment:
      <<: *common-env
      VLLM_BASE_URL: http://voxstral-vllm:8000
    depends_on:
      valkey: { condition: service_healthy }
      minio: { condition: service_healthy }

  # ─── Music Flamingo (Deep Analysis) ──────────────────────────────────────────

  flamingo-worker:
    build:
      context: .
      dockerfile: services/flamingo_worker/Dockerfile
    volumes:
      - /mnt/aetherpro/models/audio:/models:ro
    environment:
      <<: *common-env
      FLAMINGO_MODEL_ID: /models/nvidia/music-flamingo-2601-hf
      HF_TOKEN: ${HF_TOKEN:-}
      HF_HOME: /models
      NVIDIA_VISIBLE_DEVICES: "0"
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["2"]
              capabilities: [gpu]
    depends_on:
      valkey: { condition: service_healthy }
      minio: { condition: service_healthy }
    restart: unless-stopped

volumes:
  pgdata:
  miniodata:
